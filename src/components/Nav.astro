---
const links = [
  { href: "/the.gallery", label: "Home" },
  { href: "/the.gallery/projects", label: "Projects" },
  { href: "/the.gallery/profile", label: "Profiles" },
];

// Sub-links for the Gallery dropdown
const galleryLinks = [
  { href: "/the.gallery/gallery/books", label: "Books" },
  { href: "/the.gallery/gallery/blenders", label: "Blenders" },
  { href: "/the.gallery/gallery/photography", label: "Photography" },
  { href: "/the.gallery/gallery/posters", label: "Posters" },
  { href: "/the.gallery/gallery/terrariums", label: "Terrariums" },
];

// Normalize trailing slash so "/" matches both "/" and "/index"
const current = (Astro.url.pathname.replace(/\/+$/, "") || "/");
const isActive = (href) => current === (href === "/" ? "/" : href.replace(/\/+$/, ""));
const isGalleryActive = current.startsWith("/gallery");
---

<script is:inline>
  (() => {
    const dd = document.querySelector('[data-gallery-dd]');   // dropdown panel
    const btn = document.querySelector('[data-gallery-btn]'); // the trigger

    if (!dd || !btn) return;

    const open = () => dd.classList.add('is-open');
    const close = () => dd.classList.remove('is-open');
    const toggle = () => dd.classList.toggle('is-open');

    btn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggle();
    });

    // click-away to close
    document.addEventListener('click', (e) => {
      if (!dd.classList.contains('is-open')) return;
      const t = e.target;
      if (!(t instanceof Node)) return;
      if (dd.contains(t) || btn.contains(t)) return; // inside → ignore
      close();
    });

    // Esc to close
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') close();
    });
  })();
</script>

<header class="nav nav--dark" role="banner">
  <div class="nav__wrap container-narrow">
    <a href="/" class="nav__brand">THE.GALLERY</a>

    <!-- Desktop -->
    <nav aria-label="Primary" class="nav__links">
      {links.map(l => (
        <a
          href={l.href}
          class={`nav__link ${isActive(l.href) ? "is-active" : ""}`}
        >
          {l.label}<i></i>
        </a>
      ))}

      <!-- Gallery dropdown (desktop) -->
      <details class={`nav__dropdown ${isGalleryActive ? "is-active" : ""}`}>
        <summary class={`nav__link ${isGalleryActive ? "is-active" : ""}`}>
          Gallery<i></i>
        </summary>
        <div class="nav__dropdown-menu" role="menu">
          {galleryLinks.map(g => (
            <a
              href={g.href}
              class={`nav__link nav__sublink ${isActive(g.href) ? "is-active" : ""}`}
              role="menuitem"
            >
              {g.label}
            </a>
          ))}
        </div>
      </details>
    </nav>

    <!-- Mobile -->
    <details class="nav__mobile">
      <summary aria-label="Menu"><span class="nav__hamburger"></span></summary>
      <div class="nav__drawer">
        {links.map(l => (
          <a
            href={l.href}
            class={`nav__drawer-link ${isActive(l.href) ? "is-active" : ""}`}
          >
            {l.label}
          </a>
        ))}

        <!-- Gallery dropdown (mobile) -->
        <details class="nav__drawer-group" { ...(isGalleryActive ? { open: true } : {}) }>
          <summary class={`nav__drawer-link ${isGalleryActive ? "is-active" : ""}`}>
            Gallery
          </summary>
          <div class="nav__drawer-sub">
            {galleryLinks.map(g => (
              <a
                href={g.href}
                class={`nav__drawer-link nav__drawer-sublink ${isActive(g.href) ? "is-active" : ""}`}
              >
                {g.label}
              </a>
            ))}
          </div>
        </details>
      </div>
    </details>
  </div>
</header>

<style>
/* ========== Desktop dropdown (with animation) ========== */
.nav__dropdown {
  position: relative;
  display: inline-block;
}

.nav__dropdown > summary {
  list-style: none;
  cursor: pointer;
}
.nav__dropdown > summary::-webkit-details-marker { display: none; }
.nav__dropdown > summary i { display: none; } /* hide the underline bar on the summary */

/* animated panel */
.nav__dropdown-menu {
  position: absolute;
  top: calc(100% + 8px);
  left: 0;
  background: var(--bg-nav, #0f1113);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 12px;
  padding: .35rem;
  box-shadow: 0 10px 28px rgba(0,0,0,.28);
  white-space: nowrap;
  z-index: 50;

  /* animation states */
  opacity: 0;
  transform: translateY(-6px);
  pointer-events: none;
  transition: opacity .22s ease, transform .22s ease;
}

/* when dropdown is open → animate in */
.nav__dropdown[open] > .nav__dropdown-menu {
  opacity: 1;
  transform: translateY(0px);
  pointer-events: auto;
}

/* sub-links */
.nav__sublink {
  display: block;
  padding: .45rem .9rem;
  border-radius: 8px;
  text-decoration: none;
}
.nav__sublink:hover {
  background: rgba(255,255,255,.06);
}

/* ========== Mobile drawer dropdown (also animated) ========== */
.nav__drawer-group > summary {
  list-style: none;
  cursor: pointer;
}
.nav__drawer-group > summary::-webkit-details-marker { display: none; }

/* mobile collapse animation */
.nav__drawer-sub {
  display: grid;
  gap: .25rem;
  padding-left: .75rem;
  margin-top: .25rem;
  max-height: 0;
  overflow: hidden;
  transition: max-height .28s ease, opacity .28s ease;
  opacity: 0;
}

.nav__drawer-group[open] > .nav__drawer-sub {
  max-height: 500px; /* large enough to contain items */
  opacity: 1;
}

.nav__drawer-sublink {
  padding: .45rem 0;
}

/* Ensure hidden state doesn’t reserve height */
[data-gallery-dd]{ display:none; }
[data-gallery-dd].is-open{ display:block; }
</style>
